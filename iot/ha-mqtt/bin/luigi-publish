#!/bin/bash
#
# luigi-publish - Universal sensor data publisher for Luigi MQTT integration
#
# Purpose: Publish sensor values to MQTT broker for Home Assistant integration
# Why: Provides simple interface for ANY Luigi module to publish sensor data
# How: luigi-publish --sensor SENSOR_ID --value VALUE [--unit UNIT] [--device-class CLASS]
# Who: Called by Luigi modules (mario.py, temp sensors, system monitors, etc.)
#
# Key Responsibilities:
# 1. Accept sensor data via command-line arguments
# 2. Validate inputs and load MQTT configuration
# 3. Build appropriate MQTT topic for the sensor
# 4. Publish value to broker with proper formatting
# 5. Provide clear error messages and exit codes
#
# Part of Phase 2: Core Implementation

# Library path - adjust for installed location
LIB_DIR="/usr/local/lib/luigi"
if [ ! -d "$LIB_DIR" ]; then
    # Development fallback
    LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
fi

# Source MQTT helpers library
# shellcheck source=../lib/mqtt_helpers.sh
if [ -f "$LIB_DIR/mqtt_helpers.sh" ]; then
    source "$LIB_DIR/mqtt_helpers.sh"
else
    >&2 echo "Error: Cannot find mqtt_helpers.sh library"
    >&2 echo "Expected location: $LIB_DIR/mqtt_helpers.sh"
    exit 2
fi

# Script version
VERSION="1.0.0"

# Usage information
usage() {
    cat << EOF
Usage: luigi-publish --sensor SENSOR_ID --value VALUE [OPTIONS]

Publish sensor data to MQTT broker for Home Assistant integration.

Required Arguments:
  --sensor SENSOR_ID    Sensor identifier (alphanumeric, underscore, hyphen)
  --value VALUE         Sensor value to publish (numeric or string)

Optional Arguments:
  --unit UNIT          Unit of measurement (e.g., °C, %, lux)
  --device-class CLASS Home Assistant device class (temperature, humidity, etc.)
  --attributes JSON    Additional attributes as JSON string
  --binary             Publish as binary sensor (ON/OFF instead of numeric)
  --retain             Retain message on broker (default: false)
  
Information:
  -h, --help           Show this help message
  -v, --version        Show version information

Examples:
  # Publish temperature reading
  luigi-publish --sensor bedroom_temp --value 23.5 --unit °C --device-class temperature

  # Publish motion detection (binary sensor)
  luigi-publish --sensor motion_detector --value ON --binary

  # Publish humidity with attributes
  luigi-publish --sensor humidity --value 65 --unit % --attributes '{"location": "bedroom"}'

Exit Codes:
  0  Success
  1  Error (connection, validation, etc.)
  2  Missing dependencies or configuration

For more information, see: https://github.com/pkathmann88/luigi/tree/main/iot/ha-mqtt
EOF
}

# Parse command-line arguments
SENSOR_ID=""
VALUE=""
UNIT=""
DEVICE_CLASS=""
ATTRIBUTES=""
BINARY_MODE=false
RETAIN_FLAG=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --sensor)
            SENSOR_ID="$2"
            shift 2
            ;;
        --value)
            VALUE="$2"
            shift 2
            ;;
        --unit)
            UNIT="$2"
            shift 2
            ;;
        --device-class)
            DEVICE_CLASS="$2"
            shift 2
            ;;
        --attributes)
            ATTRIBUTES="$2"
            shift 2
            ;;
        --binary)
            BINARY_MODE=true
            shift
            ;;
        --retain)
            RETAIN_FLAG="retain"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            echo "luigi-publish version $VERSION"
            exit 0
            ;;
        *)
            >&2 echo "Error: Unknown option: $1"
            >&2 echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Validate required arguments
if [ -z "$SENSOR_ID" ]; then
    >&2 echo "Error: --sensor argument is required"
    >&2 echo "Use --help for usage information"
    exit 1
fi

if [ -z "$VALUE" ]; then
    >&2 echo "Error: --value argument is required"
    >&2 echo "Use --help for usage information"
    exit 1
fi

# Load MQTT configuration
if ! load_config; then
    >&2 echo "Error: Failed to load MQTT configuration"
    exit 2
fi

# Validate sensor ID
if ! validate_sensor_id "$SENSOR_ID"; then
    exit 1
fi

# Determine sensor type
SENSOR_TYPE="sensor"
if [ "$BINARY_MODE" = true ]; then
    SENSOR_TYPE="binary_sensor"
    
    # Validate binary sensor value
    if [ "$VALUE" != "ON" ] && [ "$VALUE" != "OFF" ]; then
        >&2 echo "Warning: Binary sensor value should be ON or OFF (got: $VALUE)"
        >&2 echo "         Converting to uppercase..."
        VALUE="${VALUE^^}"
    fi
fi

# Build MQTT topic
if ! TOPIC=$(build_topic "$SENSOR_TYPE" "$SENSOR_ID" "state"); then
    >&2 echo "Error: Failed to build MQTT topic"
    exit 1
fi

# Build message payload
# For simple values, just publish the value directly
# For complex data with attributes, build JSON payload
MESSAGE="$VALUE"

if [ -n "$ATTRIBUTES" ]; then
    # Validate JSON attributes
    if ! echo "$ATTRIBUTES" | jq empty 2>/dev/null; then
        >&2 echo "Error: Invalid JSON in --attributes"
        exit 1
    fi
    
    # Build JSON payload with value and attributes
    MESSAGE=$(jq -n \
        --arg value "$VALUE" \
        --argjson attrs "$ATTRIBUTES" \
        '{value: $value, attributes: $attrs}')
fi

# Publish to MQTT broker
if mqtt_publish "$TOPIC" "$MESSAGE" "$RETAIN_FLAG"; then
    # Success - optionally log (only in verbose mode)
    if [ "${MQTT_LOG_LEVEL}" = "DEBUG" ]; then
        echo "Published: $SENSOR_ID = $VALUE to $TOPIC"
    fi
    exit 0
else
    >&2 echo "Error: Failed to publish to MQTT broker"
    >&2 echo "       Sensor: $SENSOR_ID"
    >&2 echo "       Topic: $TOPIC"
    >&2 echo "       Value: $VALUE"
    >&2 echo ""
    >&2 echo "Troubleshooting:"
    >&2 echo "  1. Check MQTT broker is running: ping $MQTT_HOST"
    >&2 echo "  2. Verify credentials in /etc/luigi/iot/ha-mqtt/ha-mqtt.conf"
    >&2 echo "  3. Test connection: luigi-mqtt-status"
    >&2 echo "  4. Check broker logs for authentication errors"
    exit 1
fi
