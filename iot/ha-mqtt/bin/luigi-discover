#!/bin/bash
#
# luigi-discover - Sensor registration via MQTT Discovery for Home Assistant
#
# Purpose: Automatically register Luigi sensors in Home Assistant
# Why: Eliminates manual HA configuration, enables plug-and-play sensor integration
# How: luigi-discover [--force]
# Who: Called by setup scripts, systemd service, or manually for troubleshooting
#
# Key Responsibilities:
# 1. Scan sensors.d/ directory for sensor descriptor JSON files
# 2. Validate each descriptor format
# 3. Generate Home Assistant MQTT Discovery payloads
# 4. Publish discovery messages to broker with retain flag
# 5. Report summary of registered sensors
#
# Part of Phase 2: Core Implementation

# Library path - adjust for installed location
LIB_DIR="/usr/local/lib/luigi"
if [ ! -d "$LIB_DIR" ]; then
    # Development fallback
    LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
fi

# Source libraries
# shellcheck source=../lib/mqtt_helpers.sh
if [ -f "$LIB_DIR/mqtt_helpers.sh" ]; then
    source "$LIB_DIR/mqtt_helpers.sh"
else
    >&2 echo "Error: Cannot find mqtt_helpers.sh library"
    exit 2
fi

# shellcheck source=../lib/ha_discovery_generator.sh
if [ -f "$LIB_DIR/ha_discovery_generator.sh" ]; then
    source "$LIB_DIR/ha_discovery_generator.sh"
else
    >&2 echo "Error: Cannot find ha_discovery_generator.sh library"
    exit 2
fi

# Script version
VERSION="1.0.0"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Usage information
usage() {
    cat << EOF
Usage: luigi-discover [OPTIONS]

Discover and register Luigi sensors in Home Assistant via MQTT Discovery.

Options:
  --force              Force re-registration of all sensors
  --quiet              Minimal output (errors only)
  --verbose            Detailed output for debugging
  -h, --help           Show this help message
  -v, --version        Show version information

Description:
  Scans the sensor descriptor directory for JSON files and registers
  each sensor with Home Assistant using MQTT Discovery protocol.
  Discovery messages are published with the retain flag so sensors
  automatically reappear in HA after broker or HA restarts.

Descriptor Directory:
  Default: /etc/luigi/iot/ha-mqtt/sensors.d/
  Configure via SENSORS_DIR in ha-mqtt.conf

Examples:
  # Discover and register all sensors
  luigi-discover

  # Force re-registration (useful after descriptor changes)
  luigi-discover --force

  # Quiet mode for cron jobs
  luigi-discover --quiet

Exit Codes:
  0  Success (all sensors registered)
  1  Partial failure (some sensors failed)
  2  Complete failure (no sensors registered)

For more information, see: https://github.com/pkathmann88/luigi/tree/main/iot/ha-mqtt
EOF
}

# Parse command-line arguments
FORCE_MODE=false
QUIET_MODE=false
VERBOSE_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_MODE=true
            shift
            ;;
        --quiet)
            QUIET_MODE=true
            shift
            ;;
        --verbose)
            VERBOSE_MODE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            echo "luigi-discover version $VERSION"
            exit 0
            ;;
        *)
            >&2 echo "Error: Unknown option: $1"
            >&2 echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Load MQTT configuration
if ! load_config; then
    >&2 echo "Error: Failed to load MQTT configuration"
    exit 2
fi

# Check sensors directory exists
if [ ! -d "$MQTT_SENSORS_DIR" ]; then
    if [ "$QUIET_MODE" = false ]; then
        >&2 echo "Warning: Sensor descriptor directory not found: $MQTT_SENSORS_DIR"
        >&2 echo "         No sensors to register"
    fi
    exit 0
fi

# Display header
if [ "$QUIET_MODE" = false ]; then
    echo "========================================="
    echo "Luigi Sensor Discovery"
    echo "========================================="
    echo ""
    echo "Scanning: $MQTT_SENSORS_DIR"
    echo "Broker: $MQTT_HOST:$MQTT_PORT"
    echo ""
fi

# Counters for summary
TOTAL_COUNT=0
SUCCESS_COUNT=0
FAILED_COUNT=0

# Find all JSON descriptor files
shopt -s nullglob
DESCRIPTOR_FILES=("$MQTT_SENSORS_DIR"/*.json)
shopt -u nullglob

if [ ${#DESCRIPTOR_FILES[@]} -eq 0 ]; then
    if [ "$QUIET_MODE" = false ]; then
        echo -e "${YELLOW}No sensor descriptors found${NC}"
        echo ""
        echo "To add sensors, place JSON descriptor files in:"
        echo "  $MQTT_SENSORS_DIR"
        echo ""
        echo "Example descriptor:"
        echo '  {"sensor_id": "temp_sensor", "name": "Temperature", "module": "my-module"}'
    fi
    exit 0
fi

if [ "$QUIET_MODE" = false ]; then
    echo "Found ${#DESCRIPTOR_FILES[@]} descriptor(s)"
    echo ""
fi

# Process each descriptor
for descriptor_file in "${DESCRIPTOR_FILES[@]}"; do
    TOTAL_COUNT=$((TOTAL_COUNT + 1))
    
    descriptor_name=$(basename "$descriptor_file")
    
    if [ "$VERBOSE_MODE" = true ]; then
        echo "Processing: $descriptor_name"
    fi
    
    # Validate descriptor
    if ! validate_descriptor "$descriptor_file" 2>/dev/null; then
        FAILED_COUNT=$((FAILED_COUNT + 1))
        if [ "$QUIET_MODE" = false ]; then
            echo -e "${RED}✗${NC} $descriptor_name - Invalid descriptor"
            if [ "$VERBOSE_MODE" = true ]; then
                validate_descriptor "$descriptor_file"
            fi
        fi
        continue
    fi
    
    # Extract sensor info
    sensor_id=$(jq -r '.sensor_id' "$descriptor_file")
    sensor_name=$(jq -r '.name' "$descriptor_file")
    device_class=$(jq -r '.device_class // empty' "$descriptor_file")
    
    # Determine sensor type (binary_sensor if device_class is motion, door, etc.)
    sensor_type="sensor"
    case "$device_class" in
        motion|door|window|occupancy|smoke|moisture|light|sound|presence)
            sensor_type="binary_sensor"
            ;;
    esac
    
    # Generate discovery payload
    if [ "$sensor_type" = "binary_sensor" ]; then
        discovery_json=$(generate_binary_sensor_discovery "$descriptor_file" 2>/dev/null)
    else
        discovery_json=$(generate_sensor_discovery "$descriptor_file" 2>/dev/null)
    fi
    
    if [ -z "$discovery_json" ]; then
        FAILED_COUNT=$((FAILED_COUNT + 1))
        if [ "$QUIET_MODE" = false ]; then
            echo -e "${RED}✗${NC} $descriptor_name - Failed to generate discovery payload"
        fi
        continue
    fi
    
    # Build discovery topic
    discovery_topic=$(get_discovery_topic "$sensor_type" "$sensor_id")
    
    # Publish discovery message (always with retain flag)
    if mqtt_publish "$discovery_topic" "$discovery_json" "retain" 2>/dev/null; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        if [ "$QUIET_MODE" = false ]; then
            echo -e "${GREEN}✓${NC} $sensor_name ($sensor_type)"
            if [ "$VERBOSE_MODE" = true ]; then
                echo "    ID: $sensor_id"
                echo "    Topic: $discovery_topic"
                echo "    Class: ${device_class:-none}"
            fi
        fi
    else
        FAILED_COUNT=$((FAILED_COUNT + 1))
        if [ "$QUIET_MODE" = false ]; then
            echo -e "${RED}✗${NC} $sensor_name - Failed to publish discovery"
            if [ "$VERBOSE_MODE" = true ]; then
                echo "    Topic: $discovery_topic"
            fi
        fi
    fi
done

# Display summary
if [ "$QUIET_MODE" = false ]; then
    echo ""
    echo "========================================="
    echo "Summary"
    echo "========================================="
    echo "Total descriptors: $TOTAL_COUNT"
    echo -e "Successfully registered: ${GREEN}$SUCCESS_COUNT${NC}"
    echo -e "Failed: ${RED}$FAILED_COUNT${NC}"
    echo ""
fi

# Exit code based on results
if [ $FAILED_COUNT -eq 0 ]; then
    # All succeeded
    if [ "$QUIET_MODE" = false ]; then
        echo -e "${GREEN}✓ All sensors registered successfully${NC}"
    fi
    exit 0
elif [ $SUCCESS_COUNT -eq 0 ]; then
    # All failed
    if [ "$QUIET_MODE" = false ]; then
        echo -e "${RED}✗ No sensors were registered${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Check MQTT broker connectivity: luigi-mqtt-status"
        echo "  2. Verify descriptor files are valid JSON"
        echo "  3. Check broker logs for errors"
        echo "  4. Run with --verbose for detailed output"
    fi
    exit 2
else
    # Partial success
    if [ "$QUIET_MODE" = false ]; then
        echo -e "${YELLOW}⚠ Some sensors failed to register${NC}"
        echo "  Run with --verbose to see details"
    fi
    exit 1
fi
